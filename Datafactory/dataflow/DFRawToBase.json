{
	"name": "DFRawToBase",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "RawTiingo",
						"type": "DatasetReference"
					},
					"name": "RawTiingo"
				},
				{
					"dataset": {
						"referenceName": "AzureProjectStockList",
						"type": "DatasetReference"
					},
					"name": "GetActiveStockList"
				}
			],
			"sinks": [
				{
					"linkedService": {
						"referenceName": "azureprojectstorage",
						"type": "LinkedServiceReference"
					},
					"name": "BASETiingo"
				}
			],
			"transformations": [
				{
					"name": "NewColTicker"
				},
				{
					"name": "UpdateLastUpdateDateKey"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "UnionActiveStockList"
				},
				{
					"name": "AlterRowForUpdate"
				}
			],
			"script": "parameters{\n\tLatestTiingoFolder as string ('20210410')\n}\nsource(output(\n\t\tadjClose as double,\n\t\tadjHigh as double,\n\t\tadjLow as double,\n\t\tadjOpen as double,\n\t\tadjVolume as integer,\n\t\tclose as double,\n\t\tdate as string,\n\t\tdivCash as double,\n\t\thigh as double,\n\t\tlow as double,\n\t\topen as double,\n\t\tsplitFactor as double,\n\t\tvolume as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tlimit: 100,\n\trowUrlColumn: 'FilePath',\n\tdocumentForm: 'documentPerLine',\n\twildcardPaths:[(concat('RAW/Tiingo/',$LatestTiingoFolder,'/','*'))]) ~> RawTiingo\nsource(output(\n\t\tSimFinID as integer,\n\t\tTicker as string,\n\t\tActive as integer,\n\t\tInitialLoadDateKey as integer,\n\t\tLastUpdateDateKey as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false,\n\tlimit: 100) ~> GetActiveStockList\nRawTiingo derive(Ticker = left(substring(FilePath,22), (length(substring(FilePath,22)) - 5 ) )) ~> NewColTicker\nConditionalSplit1@ActiveStocks derive(LastUpdateDateKey = toInteger($LatestTiingoFolder)) ~> UpdateLastUpdateDateKey\nGetActiveStockList split(equals(toInteger(byName('Active')),1),\n\tdisjoint: false) ~> ConditionalSplit1@(ActiveStocks, NonActiveStocks)\nUpdateLastUpdateDateKey, ConditionalSplit1@NonActiveStocks union(byName: true)~> UnionActiveStockList\nNewColTicker alterRow(upsertIf(true())) ~> AlterRowForUpdate\nAlterRowForUpdate sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tformat: 'delta',\n\tcompressionType: 'snappy',\n\tcompressionLevel: 'Fastest',\n\tcontainer: 'datalake',\n\tfolderPath: 'BASE/EoDStockPrice',\n\tmergeSchema: false,\n\tautoCompact: false,\n\toptimizedWrite: false,\n\tvacuum: 0,\n\tdeletable:true,\n\tinsertable:true,\n\tupdateable:true,\n\tupsertable:true,\n\tkeys:['date','Ticker'],\n\tpartitionFileNames:['TiingoEoDPrices.csv'],\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true,\n\tsaveOrder: 1) ~> BASETiingo"
		}
	}
}